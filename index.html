<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Klokah MP3 擷取工具</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    #progress-container {
      display: none;
      margin-top: 10px;
      width: 100%;
      background-color: #eee;
    }
    #progress-bar {
      width: 0%;
      height: 20px;
      background-color: #4caf50;
      text-align: center;
      color: white;
      line-height: 20px;
    }
  </style>
</head>
<body>
  <h1>Klokah MP3 擷取工具</h1>
  <input type="text" id="search" placeholder="搜尋句子..." style="width: 60%;">
  <button onclick="fetchMp3Links()">擷取 MP3</button>
  <button onclick="downloadAllZip()">⬇️ 一鍵打包下載</button>
  <div id="progress-container">
    <div id="progress-bar">0%</div>
  </div>
  <div id="result"></div>

  <script>
    let mp3Data = [];

    async function fetchMp3Links() {
      const proxy = "https://api.allorigins.win/raw?url=";
      const urlInput = prompt("請輸入 klokah 網址 (如：https://web.klokah.tw/text/read.php?tid=435)");
      if (!urlInput) return;
      const url = proxy + encodeURIComponent(urlInput);

      const res = await fetch(url);
      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');

      const abList = Array.from(doc.querySelectorAll('div.read-sentence.Ab'));
      const chList = Array.from(doc.querySelectorAll('div.read-sentence.Ch'));
      const sources = Array.from(doc.querySelectorAll('#audioSet audio source'));
      const zipLink = doc.querySelector("a[href*='php/downloadZip.php?tid=']")?.href;

      mp3Data = [];
      const result = document.getElementById('result');
      result.innerHTML = "";

      sources.forEach((el, i) => {
        const src = el.getAttribute('src');
        const ab = abList[i]?.textContent.trim() || "ab" + (i + 1);
        const ch = chList[i]?.textContent.trim() || "ch" + (i + 1);
        const fullUrl = new URL(src, urlInput).href;
        const filename = ch.replace(/[^一-龥\w\d]/g, '_') + '.mp3';

        mp3Data.push({ url: fullUrl, filename: filename, ab, ch });

        const block = document.createElement('div');
        block.innerHTML = `
          <p><strong>Ab:</strong> ${ab}</p>
          <p><strong>Ch:</strong> ${ch}</p>
          <audio controls src="${fullUrl}"></audio><br>
          <a href="${fullUrl}" download="${filename}">⬇️ 下載音檔</a>
          <hr>
        `;
        result.appendChild(block);
      });

      if (zipLink) {
        const zipBtn = document.createElement('p');
        zipBtn.innerHTML = `<a href="${zipLink}" target="_blank">⬇️ 下載全部音檔（ZIP）</a>`;
        result.prepend(zipBtn);
      }
    }

    function downloadAllZip() {
      if (mp3Data.length === 0) return alert("請先擷取 MP3");
      const zip = new JSZip();
      const progressBar = document.getElementById("progress-bar");
      const progressContainer = document.getElementById("progress-container");

      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";

      let completed = 0;

      const downloadPromises = mp3Data.map((data, index) =>
        fetch(data.url)
          .then(res => res.blob())
          .then(blob => {
            zip.file(data.filename, blob);
            completed++;
            const percent = Math.round((completed / mp3Data.length) * 100);
            progressBar.style.width = percent + "%";
            progressBar.textContent = percent + "%";
          })
      );

      Promise.all(downloadPromises).then(() => {
        zip.generateAsync({ type: 'blob' }).then(content => {
          saveAs(content, "klokah_mp3s.zip");
          progressBar.textContent = "完成";
        });
      });
    }

    document.getElementById('search').addEventListener('input', function() {
      const keyword = this.value.trim();
      const result = document.getElementById('result');
      result.innerHTML = "";
      const filtered = keyword === "" ? mp3Data : mp3Data.filter(d => d.ab.includes(keyword) || d.ch.includes(keyword));

      filtered.forEach(({ ab, ch, url, filename }) => {
        const block = document.createElement('div');
        block.innerHTML = `
          <p><strong>Ab:</strong> ${ab}</p>
          <p><strong>Ch:</strong> ${ch}</p>
          <audio controls src="${url}"></audio><br>
          <a href="${url}" download="${filename}">⬇️ 下載音檔</a>
          <hr>
        `;
        result.appendChild(block);
      });
    });
  </script>
</body>
</html>
