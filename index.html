<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Klokah 音檔擷取工具</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    input, button { margin: 0.5em 0; padding: 0.5em; }
    .sentence { margin: 1em 0; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
  </style>
</head>
<body>

  <h1>Klokah 音檔擷取工具</h1>
  <input type="text" id="url" size="60" placeholder="貼上 klokah 網址（如 https://web.klokah.tw/text/read.php?tid=8030）">
  <button id="fetch">擷取內容</button>

  <div id="download-zip" style="margin-top: 2em;"></div>
  <div id="results"></div>

  <script>
    $('#fetch').click(async function () {
      const url = $('#url').val();
      if (!url.includes('tid=')) {
        alert('網址格式錯誤');
        return;
      }

      const tid = url.split('tid=')[1].split('&')[0];
      const proxiedURL = `https://corsproxy.io/?${encodeURIComponent(url)}`;
      $('#results').html('載入中...');
      $('#download-zip').empty();

      try {
        const html = await $.get(proxiedURL);
        const doc = $(html);

        const abList = doc.find('.read-sentence.Ab');
        const chList = doc.find('.read-sentence.Ch');
        const audioList = doc.find('#audioSet audio');

        const zipLink = `https://web.klokah.tw/text/php/downloadZip.php?tid=${tid}`;
        $('#download-zip').html(`<a href="${zipLink}" target="_blank">📦 一鍵下載所有音檔 (ZIP)</a>`);

        $('#results').empty();

        for (let i = 0; i < audioList.length; i++) {
          const audio = $(audioList[i]);
          const id = audio.attr('data-value');
          const src = audio.find('source').attr('src');

          const abText = abList.filter(`[data-value=${id}]`).text().trim().replace(/\s+/g, ' ');
          const chText = chList.filter(`[data-value=${id}]`).text().trim();

          $('#results').append(`
            <div class="sentence">
              <p><strong>原文：</strong>${abText}</p>
              <p><strong>翻譯：</strong>${chText}</p>
              <audio controls src="${src}"></audio><br>
              <a href="${src}" download>⬇️ 下載 MP3</a>
            </div>
          `);
        }

      } catch (e) {
        $('#results').html('❌ 擷取失敗，請確認網址正確且網頁可公開讀取。');
        console.error(e);
      }
    });
  </script>

</body>
</html>
