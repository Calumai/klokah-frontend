<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Klokah 音檔顯示工具</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    input, button { padding: 8px; margin: 10px 0; }
    .sentence-block { padding: 10px; background: white; margin: 10px 0; border-radius: 5px; }
    audio { display: block; margin-top: 5px; }
    .zip-link { margin: 20px 0; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Klokah 音檔擷取顯示工具</h2>
  <p>輸入 klokah 網址，例如：https://web.klokah.tw/text/read.php?tid=8030</p>
  <input type="text" id="url" size="70" placeholder="請輸入 klokah 網址">
  <button id="load">載入音檔</button>

  <div id="zip-link" class="zip-link"></div>
  <div id="results"></div>

  <script>
    $('#load').click(async function () {
      const inputUrl = $('#url').val();
      if (!inputUrl) return alert('請輸入網址');

      $('#results').html('載入中...');
      $('#zip-link').html('');

      try {
        const html = await $.get(`https://corsproxy.io/?${encodeURIComponent(inputUrl)}`);
        const $doc = $(html);

        // 1. 顯示 zip 檔案連結
        const zipHref = $doc.find("a[href*='downloadZip.php']").attr('href');
        if (zipHref) {
          const fullZipUrl = new URL(zipHref, inputUrl).href;
          $('#zip-link').html(`<a href="${fullZipUrl}" target="_blank">⬇️ 下載 ZIP 音檔</a>`);
        }

        // 2. 顯示每句的音檔連結與播放
        const $audios = $doc.find('#audioSet audio source');
        const $chTexts = $doc.find('.read-sentence.Ch');

        const resultHtml = [];
        $audios.each(function (i) {
          const mp3Url = $(this).attr('src');
          const chText = $($chTexts[i]).text().trim();
          if (mp3Url && chText) {
            resultHtml.push(`
              <div class="sentence-block">
                <div>${chText}</div>
                <audio controls src="${mp3Url}"></audio>
                <a href="${mp3Url}" download>下載 MP3</a>
              </div>
            `);
          }
        });

        $('#results').html(resultHtml.join(''));
      } catch (e) {
        $('#results').html('❌ 載入失敗，請確認網址是否正確或可公開存取');
      }
    });
  </script>
</body>
</html>
