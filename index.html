<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>KLOKAH 音檔下載工具</title>
</head>
<body>
  <h1>輸入網址，自動提取音檔</h1>
  <input type="text" id="targetUrl" placeholder="貼上 klokah 網址">
  <button onclick="fetchAndShowLinks()">取得音檔</button>

  <div id="result"></div>

  <script>
    async function fetchAndShowLinks() {
      const url = document.getElementById("targetUrl").value;
      const tidMatch = url.match(/tid=(\d+)/);
      const tid = tidMatch ? tidMatch[1] : null;

      if (!tid) return alert("無法解析 tid，請確認網址格式");

      const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;

      const res = await fetch(proxyUrl);
      const html = await res.text();

      const div = document.createElement("div");
      div.innerHTML = html;

      const audioTags = div.querySelectorAll("audio > source");
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `<h2>逐句 MP3 音檔 (${audioTags.length} 筆)</h2>`;

      audioTags.forEach((el, i) => {
        const href = el.getAttribute("src");
        const name = href.split("/").pop();
        const a = document.createElement("a");
        a.href = href;
        a.download = name;
        a.innerText = `下載 ${name}`;
        a.style.display = "block";
        resultDiv.appendChild(a);
      });

      const zipLink = div.querySelector(`a[href*='downloadZip.php?tid=${tid}']`);
      if (zipLink) {
        const a = document.createElement("a");
        a.href = `https://web.klokah.tw/text/php/downloadZip.php?tid=${tid}`;
        a.download = `tid_${tid}.zip`;
        a.innerText = "🔽 下載整包 ZIP 音檔";
        a.style.display = "block";
        a.style.marginTop = "1em";
        resultDiv.appendChild(a);
      }
    }
  </script>
</body>
</html>
