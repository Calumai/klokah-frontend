<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Klokah éŸ³æª”æ“·å–å·¥å…·</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    input, button { padding: 8px; margin: 10px 0; }
    .sentence { background: white; border-radius: 6px; padding: 10px; margin: 10px 0; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .sentence audio { display: block; margin-top: 5px; }
    .zip-link { margin: 20px 0; font-weight: bold; }
  </style>
</head>
<body>

<h2>Klokah éŸ³æª”æ“·å–å·¥å…·</h2>
<p>è«‹è¼¸å…¥ klokah èª²æ–‡ç¶²å€ï¼ˆä¾‹å¦‚ <code>https://web.klokah.tw/text/read.php?tid=8030</code>ï¼‰</p>

<input type="text" id="url" size="60" placeholder="è«‹è¼¸å…¥ klokah ç¶²å€">
<button id="fetch">æ“·å–å…§å®¹</button>

<div class="zip-link" id="download-link"></div>
<div id="results"></div>

<script>
  $('#fetch').click(async function () {
    const url = $('#url').val().trim();
    if (!url.includes('tid=')) {
      alert('ç¶²å€éŒ¯èª¤ï¼Œè«‹ç¢ºèªåŒ…å« tid=');
      return;
    }

    const tid = url.split('tid=')[1].split('&')[0];
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
    $('#results').html('è¼‰å…¥ä¸­...');
    $('#download-link').html('');

    try {
      const html = await $.get(proxyUrl);
      const $doc = $(html);
      const audios = $doc.find('#audioSet audio');
      const chList = $doc.find('.read-sentence.Ch');
      const abList = $doc.find('.read-sentence.Ab');

      $('#download-link').html(`<a href="https://web.klokah.tw/text/php/downloadZip.php?tid=${tid}" target="_blank">ğŸ“¦ ä¸€éµä¸‹è¼‰ ZIP éŸ³æª”</a>`);
      $('#results').empty();

      audios.each(function () {
        const id = $(this).attr('data-value');
        const src = $(this).find('source').attr('src');
        const chText = chList.filter(`[data-value="${id}"]`).text().trim();
        const abText = abList.filter(function () {
          return $(this).find('.read-chinese-btn[data-value="' + id + '"]').length > 0;
        }).text().replace(chText, '').trim();

        if (src && chText) {
          $('#results').append(`
            <div class="sentence">
              <div><strong>åŸæ–‡ï¼š</strong>${abText}</div>
              <div><strong>ç¿»è­¯ï¼š</strong>${chText}</div>
              <audio controls src="${src}"></audio>
              <a href="${src}" download>â¬‡ï¸ ä¸‹è¼‰ MP3</a>
            </div>
          `);
        }
      });

      if ($('#results').html().trim() === '') {
        $('#results').html('âŒ æ‰¾ä¸åˆ°ä»»ä½•å¥å­æˆ–éŸ³æª”ã€‚');
      }
    } catch (err) {
      console.error(err);
      $('#results').html('âŒ æ“·å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²é æ ¼å¼ã€‚');
    }
  });
</script>

</body>
</html>
