<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Klokah éŸ³æª”æ“·å–å·¥å…·</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    input, button { margin: 0.5em 0; padding: 0.5em; }
    .sentence { margin: 1em 0; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
  </style>
</head>
<body>

  <h1>Klokah éŸ³æª”æ“·å–å·¥å…·</h1>
  <input type="text" id="url" size="60" placeholder="è²¼ä¸Š klokah ç¶²å€ï¼ˆå¦‚ https://web.klokah.tw/text/read.php?tid=8030ï¼‰">
  <button id="fetch">æ“·å–å…§å®¹</button>

  <div id="download-zip" style="margin-top: 2em;"></div>
  <div id="results"></div>

  <script>
    $('#fetch').click(async function () {
      const url = $('#url').val();
      if (!url.includes('tid=')) {
        alert('ç¶²å€æ ¼å¼éŒ¯èª¤');
        return;
      }

      const tid = url.split('tid=')[1].split('&')[0];
      const proxiedURL = `https://corsproxy.io/?${encodeURIComponent(url)}`;
      $('#results').html('è¼‰å…¥ä¸­...');
      $('#download-zip').empty();

      try {
        const html = await $.get(proxiedURL);
        const doc = $(html);

        const abList = doc.find('.read-sentence.Ab');
        const chList = doc.find('.read-sentence.Ch');
        const audioList = doc.find('#audioSet audio');

        const zipLink = `https://web.klokah.tw/text/php/downloadZip.php?tid=${tid}`;
        $('#download-zip').html(`<a href="${zipLink}" target="_blank">ğŸ“¦ ä¸€éµä¸‹è¼‰æ‰€æœ‰éŸ³æª” (ZIP)</a>`);

        $('#results').empty();

        for (let i = 0; i < audioList.length; i++) {
          const audio = $(audioList[i]);
          const id = audio.attr('data-value');
          const src = audio.find('source').attr('src');

          const abText = abList.filter(`[data-value=${id}]`).text().trim().replace(/\s+/g, ' ');
          const chText = chList.filter(`[data-value=${id}]`).text().trim();

          $('#results').append(`
            <div class="sentence">
              <p><strong>åŸæ–‡ï¼š</strong>${abText}</p>
              <p><strong>ç¿»è­¯ï¼š</strong>${chText}</p>
              <audio controls src="${src}"></audio><br>
              <a href="${src}" download>â¬‡ï¸ ä¸‹è¼‰ MP3</a>
            </div>
          `);
        }

      } catch (e) {
        $('#results').html('âŒ æ“·å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€æ­£ç¢ºä¸”ç¶²é å¯å…¬é–‹è®€å–ã€‚');
        console.error(e);
      }
    });
  </script>

</body>
</html>
