<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Klokah MP3 擷取工具</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .sentence-block { margin: 10px 0; }
    .progress-bar { width: 100%; background: #eee; height: 10px; margin: 10px 0; }
    .progress-fill { background: #4caf50; height: 100%; width: 0%; }
  </style>
</head>
<body>
  <h1>Klokah MP3 擷取工具</h1>
  <input type="text" id="url" placeholder="貼上 klokah 網址" style="width: 80%;">
  <button id="fetch">擷取</button>
  <button id="downloadAll">⬇️ 下載全部</button>
  <input type="text" id="search" placeholder="🔍 搜尋句子" style="float: right;">
  <div class="progress-bar"><div class="progress-fill"></div></div>
  <div id="results"></div>

  <script>
    let mp3Data = [];

    function updateProgress(percent) {
      $('.progress-fill').css('width', percent + '%');
    }

    $('#fetch').click(function() {
      const url = $('#url').val();
      if (!url) return alert('請輸入網址');

      $.get("https://corsproxy.io/?" + encodeURIComponent(url), function(html) {
        const $html = $(html);
        const ab = $html.find('.read-sentence.Ab');
        const ch = $html.find('.read-sentence.Ch');
        const mp3s = $html.find('#audioSet audio source');

        mp3Data = [];

        $('#results').empty();
        ab.each((i, el) => {
          const abText = $(el).text().trim();
          const chText = $(ch[i]).text().trim();
          const mp3Url = $(mp3s[i]).attr('src');
          if (abText && chText && mp3Url) {
            mp3Data.push({ name: chText, url: mp3Url });
            $('#results').append(`
              <div class="sentence-block">
                <b>${chText}</b><br>
                <i>${abText}</i><br>
              <audio controls src="${'https://corsproxy.io/?' + mp3Url}"></audio>
              </div>
            `);
          }
        });
        updateProgress(100);
      });
    });

    $('#downloadAll').click(async function() {
      if (!mp3Data.length) return alert('尚未擷取任何音檔');
      const zip = new JSZip();
      for (let i = 0; i < mp3Data.length; i++) {
        const d = mp3Data[i];
        const resp = await fetch(`https://corsproxy.io/?${d.url}`);
        const blob = await resp.blob();
        zip.file(`${i+1}_${d.name}.mp3`, blob);
        updateProgress(((i + 1) / mp3Data.length) * 100);
      }
      zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, "klokah-audio.zip");
      });
    });

    $('#search').on('input', function() {
      const q = $(this).val();
      $('.sentence-block').each(function() {
        const text = $(this).text();
        $(this).toggle(text.includes(q));
      });
    });
  </script>
</body>
</html>
