<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Klokah éŸ³æª”æ“·å–å·¥å…·</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f7f7f7; }
    input, button { padding: 8px; margin: 5px 0; }
    .progress { margin-top: 10px; }
    audio { margin: 5px 0; display: block; }
    .sentence-block { margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 5px; box-shadow: 0 0 3px #ccc; }
  </style>
</head>
<body>
  <h1>Klokah éŸ³æª”æ“·å–å·¥å…·</h1>
  <p>è¼¸å…¥ klokah é é¢ç¶²å€ï¼ˆä¾‹å¦‚ï¼š<code>https://web.klokah.tw/text/read.php?tid=435</code>ï¼‰</p>
  <input type="text" id="url" placeholder="è«‹è¼¸å…¥ klokah ç¶²å€" size="60">
  <button id="fetch">æ“·å–éŸ³æª”</button>
  <br>
  <input type="text" id="search" placeholder="ğŸ” æœå°‹å¥å­æ–‡å­—ä»¥éæ¿¾ä¸‹è¼‰" size="40">
  <button id="download-all">â¬‡ï¸ ä¸€éµä¸‹è¼‰ MP3</button>
  <div class="progress" id="progress"></div>
  <div id="results"></div>

  <script>
    let mp3List = [];

    $('#fetch').click(async function () {
      const url = $('#url').val();
      if (!url) return alert('è«‹è¼¸å…¥ç¶²å€');
      $('#results').html('ğŸ“¥ è¼‰å…¥ä¸­...');
      try {
        const html = await $.get(`https://corsproxy.io/?${encodeURIComponent(url)}`);
        const abList = $(html).find('div.read-sentence.Ab').toArray();
        const chList = $(html).find('div.read-sentence.Ch').toArray();
        const mp3ListRaw = $(html).find('#audioSet audio source').toArray();
        $('#results').empty();
        mp3List = [];

        for (let i = 0; i < abList.length; i++) {
          const abText = $(abList[i]).text().trim();
          const chText = $(chList[i]).text().trim();
          const mp3Url = $(mp3ListRaw[i]).attr('src');
          const fileName = chText.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '_').substring(0, 30) + '.mp3';

          if (mp3Url) {
            mp3List.push({ url: mp3Url, name: fileName, ab: abText, ch: chText });

            $('#results').append(`
              <div class="sentence-block">
                <b>${chText}</b><br>
                <i>${abText}</i><br>
                <audio controls src="https://corsproxy.io/?${mp3Url}"></audio>
              </div>
            `);
          }
        }
      } catch (err) {
        $('#results').html('âŒ ç„¡æ³•æ“·å–ç¶²é å…§å®¹ï¼Œå¯èƒ½æ˜¯ç¶²å€éŒ¯èª¤æˆ– CORS é˜»æ“‹');
      }
    });

    $('#download-all').click(async function () {
      const keyword = $('#search').val().toLowerCase();
      const zip = new JSZip();
      let count = 0;
      $('#progress').text('â³ é–‹å§‹æ‰“åŒ…ä¸‹è¼‰...');

      for (const item of mp3List) {
        if (keyword && !item.ch.toLowerCase().includes(keyword)) continue;
        try {
          const blob = await fetch(`https://corsproxy.io/?${item.url}`).then(r => r.blob());
          zip.file(item.name, blob);
          count++;
          $('#progress').text(`âœ… å·²åŠ å…¥ ${count} å€‹éŸ³æª”...`);
        } catch (e) {
          console.warn('ä¸‹è¼‰å¤±æ•—', item.url);
        }
      }

      if (count === 0) return alert('âš ï¸ æ²’æœ‰ç¬¦åˆçš„éŸ³æª”å¯ä¸‹è¼‰');
      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, 'klokah_mp3.zip');
      $('#progress').text('âœ… éŸ³æª”å·²æ‰“åŒ…å®Œæˆ');
    });
  </script>
</body>
</html>
